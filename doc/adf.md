# **ADF検定**
※参考: [Pythonで時系列解析・超入門 (その1)](https://www.salesanalytics.co.jp/datascience/datascience085/)
※../src/adf.ipynbで使用

## **時系列の主な4つの成分**
時系列データの原系列は主に以下の4つの変動成分で構成される。

1. <font color="salmon">T：趨勢変動成分</font>
    - データの長期的な増加または減少を表現する成分
2. <font color="salmon">C：循環変動成分</font>
    - 周期的なパターンを表現する成分
    - 季節変動成分と似たような概念だが、季節変動成分が一定の周期を持っているのに対し、こちらの周期は一定である必要はない
    - 季節変動成分と異なり、2年以上と長い
- <font color="salmon">S：季節変動成分</font>
    - 一定の周期パターンを持った成分。例えば、データの粒度が1日単位であれば、週周期や年周期など。循環変動成分と比べ、周期が短く長くても1年程度。
- <font color="salmon">I：不規則変動成分</font>

- 以下のようにまとめることもある
    - TC（趨勢循環変動成分）-> トレンド成分
    - S（季節変動成分）-> 季節成分
    - I（不規則変動成分）-> 残差成分

## **3つの特徴把握方法**
1. 時系列データの変動成分の分解
2. 時系列データが定常化どうかの確認
3. コレログラム ( ACF & PACF ) の確認

## **加法モデルと情報モデル**
- 加法モデル
    - 原系列 ＝ T+C+S+I

- 乗法モデル
    - 原系列 ＝ T×C×S×I

## **時系列データの変動成分の分解**
時系列データを手にしたら先ずすべきは、以下の3つの変動成分の分解。どのような時系列データなのか、ざっくり掴める。
1. 移動平均法を利用した分解（加法モデルを仮定）
2. 移動平均法を利用した分解（乗法モデルを仮定）
    - statsmodelsライブラリーのseasonal_decompose()関数を使う
        1. 設定した季節性の周期の移動平均を計算しトレンド成分とする
        2. 原系列からトレンド成分を除去し季節成分（平均値を0に調整）を求める
        3. 原系列からトレンド成分と季節成分を除去し残差を求める
3. STL分解（LOESS平滑化を利用した分解）
    - statsmodelsライブラリーのSTL()関数を使う。
    - これが無難。外れ値に強い

## **時系列データが定常かどうかの確認**
定常な時系列データは、時間によって平均や分散、共分散が変化しない時系列データのこと。トレンド成分や季節成分がある時系列データは非定常と言える可能性が高い。例えば、時間とともにデータの値が大きくなる場合、それは時間に依存しているため、非定常な時系列データといえる。古典的な時系列解析手法では、どうすれば非定常な時系列データが定常状態になるかを検討するステップを挟む。そうすることで、トレンド成分を考慮したモデルを作るべきなのか、季節成分を考慮したモデルを作るべきなのかが分かる。

### ADF検定 ( 拡張ディッキーフラー検定, argmented Dicky-Fuller test )

- 帰無仮説H0：時系列は非定常である（単位根をもつ）
- 対立仮説H1：時系列は定常である（単位根をもたない）

<font color="salmon">単位根過程</font> ( 単位根を持つ時系列データ )は、原系列は否定上であるが、差分を取ると定常になるデータ。単位根の有無を検定する方法の一つがDF検定。それを拡張したのが、ADF検定。株価データなどの金融データ経済データの多くは単位根過程の1つであるランダムウォークに従うと言われる。また有名なARIMA、SARIMAモデルも単位根過程の一種。つまり単位根が確認できればARIMAやSARIMAモデルが使える、反対に確認できないければ使えない。

### 4つのADF検定

1. 原系列に対するADF検定
    - 通常はここで定常であるという結果はでない
2. 原系列を対数変換し得た対数系列に対するADF検定
    - 時間とともに分散が増加するといった現象を抑えることができる
3. 対数系列の階差系列（次数1）に対するADF検定
    - 原系列を対数変化し得た対数系列に対し、1期前との差分を計算し新たな時系列データを作り、その新たな時系列データに対するADF検定
    - 線形トレンドは、階差系列（次数1）を作ることで除去可能
4. 対数系列の階差系列（次数1）の季節階差系列（次数1）に対するADF検定
    - 原系列の対数系列の階差系列（次数1）に対し、12期前（1年前）との差分を計算し新たな時系列データを作り、その新たな時系列データに対するADF検定

- 結果の観察、評価
    - p値（p-value）が0.01より小さいとき1%有意、0.05より小さいとき5%有意、0.1より小さいとき10%有意と呼ばれる。
    - 有意の場合、帰無仮説（時系列は非定常である）を棄却し対立仮説（時系列は定常である）を採択する
    - このことは、ADF統計量（ADF Statistic）と棄却限界値（critical value）からも見て取れる。
    - ADF統計量（ADF Statistic）が1%棄却限界値（critical value）より小さいとき1%有意、5%棄却限界値（critical value）より小さいとき5%有意、10%棄却限界値（critical value）より小さいとき10%有意。
    - どの基準（1%有意、5%有意、10%有意）を使うかという問題があるが、1%有意が最も厳しく、10%有意が最もゆるい。伝統的に、5%有意を使うケースが多い。


### 3つの定常化の方法

1. トレンド除去
    - トレンド成分を原系列から除去することで定常化
    - トレンドを除去した時系列データを求めるには、scipyライブラリーのdetrend()関数で実施できる。
2. 差分化
    - n期前のデータとの差分をとることで定常化
    - 線形トレンドや季節性のある時系列データに対し有効。線形トレンドであれば、1期前のデータとの差分をとることで定常化に近づく。季節的なパターン（n周期）であれば、n期前のデータとの差分をとることで定常化に近づく。
    - Pythonで差分化するときは、pandasライブラリーのdiff()関数で実施できる
3. Box-Cox変換
    - 原系列に対しBox-Cox変換することで定常化。対数変換（log）を一般化したもの
    - scipyライブラリーのboxcox()関数で実施できる。

## **コレログラム**
- コレログラムとは、自己相関 (ACF)と偏自己相関 (PACF)を計算し、それをプロットしたグラフ。自己相関関数(ACF, Autocorrelation function)と偏自己相関関数(PCAF, Parcial Autocorrelation function)は、任意の時刻のデータyt とそのk個前のデータyt−k の関係性を示す-1 から1の間の値。ACFは ${y_k}$ と ${y_{t−k}}$ との間の線形的な相関の強さを、PCAFは ${y_k}$ と ${y_{t−k}}$ に対する ${y_{t−k}}$ 以外の項の影響を除いた相関の強さを示しす。
- 原系列のトレンド成分の影響がそのまま出る。
- 数値が跳ね上がっているところで周期があると考えれれる。
- ARIMA系のモデルを検討するときに参考にすることが多い

